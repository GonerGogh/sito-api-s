<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Alumno - Portal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2, h3 { margin-top: 20px; }
    #calificaciones ul { list-style: none; padding: 0; }
    #calificaciones li { margin-bottom: 5px; }
    form { margin-top: 10px; }
    label { display: block; margin-bottom: 5px; }
    input { padding: 5px; margin-bottom: 10px; width: 200px; }
    button { padding: 5px 10px; margin-top: 5px; }
    #msg { color: green; }
    #errMsg { color: red; }
  </style>
</head>
<body>

  <h2>Bienvenido <span id="userName"></span></h2>

  <h3>Grupos y Calificaciones</h3>
  <div id="calificaciones">Cargando...</div>

  <h3>Cambiar Contraseña</h3>
  <form id="passwordForm">
    <label>Nueva contraseña: <input type="password" id="newPassword" required></label>
    <button type="submit">Cambiar</button>
  </form>
  <p id="msg"></p>
  <p id="errMsg"></p>

  <button id="logout">Cerrar sesión</button>

<script>
  // ====== Inicializar dashboard ======
  function initDashboard() {
    const token = localStorage.getItem("token");
    const matricula = localStorage.getItem("matricula");

    if (!token || !matricula) {
      window.location.href = "login.html"; // si no hay sesión, redirige
      return;
    }

    document.getElementById("userName").innerText = matricula;

    // Obtener calificaciones
    fetch(`http://localhost:5004/alumnos/${matricula}/calificaciones`, {
      headers: { "Authorization": token }
    })
    .then(res => res.json())
    .then(data => {
      const cont = document.getElementById("calificaciones");
      if(data.calificaciones && data.calificaciones.length){
        let html = "<ul>";
        data.calificaciones.forEach(c => {
          html += `<li>Grupo: ${c.grupo} - Calificación: ${c.calificacion} - Profesor: ${c.profesor}</li>`;
        });
        html += "</ul>";
        cont.innerHTML = html;
      } else {
        cont.innerHTML = "<p>No hay calificaciones.</p>";
      }
    })
    .catch(()=>{ document.getElementById("calificaciones").innerHTML = "<p>Error al obtener calificaciones.</p>"; });

    // Cambiar contraseña
    const passwordForm = document.getElementById("passwordForm");
    passwordForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const nueva = document.getElementById("newPassword").value;
      try {
        const res = await fetch(`http://localhost:5004/alumnos/${matricula}/cambiar_contrasena`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({nueva_contrasena: nueva})
        });
        const data = await res.json();
        if(res.ok){
          document.getElementById("msg").innerText = data.msg;
          document.getElementById("errMsg").innerText = "";
        } else {
          document.getElementById("errMsg").innerText = data.error || "Error cambiando contraseña";
          document.getElementById("msg").innerText = "";
        }
      } catch(err){
        document.getElementById("errMsg").innerText = "Servidor no disponible";
        document.getElementById("msg").innerText = "";
      }
    });

    // Logout
    document.getElementById("logout").addEventListener("click", ()=>{
      localStorage.removeItem("token");
      localStorage.removeItem("matricula");
      window.location.href = "login.html"; // redirige al login
    });
  }

  // ====== Ejecutar al cargar ======
  initDashboard();
</script>

</body>
</html>
