<!DOCTYPE html>
<html lang="es">
<head>
 <meta charset="UTF-8">
 <title>Alumno - Portal</title>
 <style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2, h3 { margin-top: 20px; }
  #calificaciones ul { list-style: none; padding: 0; }
  #calificaciones li { margin-bottom: 5px; }
  form { margin-top: 10px; }
  label { display: block; margin-bottom: 5px; }
  input { padding: 5px; margin-bottom: 10px; width: 200px; }
  button { padding: 5px 10px; margin-top: 5px; }
  #msg { color: green; }
  #errMsg { color: red; }
 </style>
</head>
<body>

 <h2>Bienvenido <span id="userName"></span></h2>

 <h3>Grupos y Calificaciones</h3>
 <div id="calificaciones">Cargando...</div>

 <h3>Cambiar Contrase침a</h3>
 <form id="passwordForm">
  <label>Nueva contrase침a: <input type="password" id="newPassword" required></label>
  <button type="submit">Cambiar</button>
 </form>
 <p id="msg"></p>
 <p id="errMsg"></p>

 <button id="logout">Cerrar sesi칩n</button>

<script>
마sync function initDashboard() {
 const token = localStorage.getItem("token");
 const matricula = localStorage.getItem("matricula");

 if (!token || !matricula) {
  window.location.href = "login.html";
  return;
 }

 document.getElementById("userName").innerText = matricula;

 const cont = document.getElementById("calificaciones");
 cont.innerHTML = "Cargando...";

 try {
  // Petici칩n 1: Obtener la lista de grupos a los que pertenece el alumno
  const resGrupos = await fetch(`http://localhost:5004/alumnos/${matricula}/grupo`);
  const gruposAlumno = await resGrupos.json();

  // Petici칩n 2: Obtener las calificaciones del alumno
  const resCalificaciones = await fetch(`http://localhost:5004/alumnos/${matricula}/calificaciones`, {
   headers: { "Authorization": token }
  });
  const dataCalificaciones = await resCalificaciones.json();
  const calificacionesAlumno = dataCalificaciones.calificaciones || [];

  if (resGrupos.status === 404) {
   cont.innerHTML = "<p>No est치s inscrito en ning칰n grupo.</p>";
   return;
  }

  let html = "<ul>";
  gruposAlumno.forEach(grupo => {
   const calificacionObj = calificacionesAlumno.find(c => c.grupo === grupo.nombre_grupo);
   const calificacion = calificacionObj ? calificacionObj.calificacion : "N/A";
   
   // 游눠 L칤nea corregida para mostrar el nombre y la matr칤cula del profesor
   const profesorNombre = (grupo.profesor_responsable && grupo.profesor_responsable.nombre) ? grupo.profesor_responsable.nombre : 'Sin asignar';
      const profesorMatricula = (grupo.profesor_responsable && grupo.profesor_responsable.matricula) ? ` (${grupo.profesor_responsable.matricula})` : '';

   html += `
    <li>
     Grupo: ${grupo.nombre_grupo} - 
     Profesor: ${profesorNombre}${profesorMatricula} - 
     Calificaci칩n: ${calificacion}
    </li>
   `;
  });
  html += "</ul>";
  cont.innerHTML = html;

 } catch(err) {
  document.getElementById("calificaciones").innerHTML = `<p>Error al obtener los datos. (${err.message})</p>`;
 }

 // Resto de la funci칩n para cambiar contrase침a y cerrar sesi칩n
 const passwordForm = document.getElementById("passwordForm");
 passwordForm.addEventListener("submit", async (e) => { /* ... */ });
 document.getElementById("logout").addEventListener("click", () => { /* ... */ });
}

// Ejecutar al cargar
initDashboard();
</script>

</body>
</html>